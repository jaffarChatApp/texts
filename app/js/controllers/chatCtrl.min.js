ChatApp.controller("chatCtrl",["$scope","$rootScope","$http","$state","$sessionStorage","$stateParams","$interval","$timeout","$mdToast","$anchorScroll","CONFIG",function(e,s,t,a,n,o,r,c,i,d,h){e.getUserData("chat");var g=!1;e.messageData={message:"",fromUser:o.fromUserId,toUser:o.toUserId,senderName:"",recieverName:"",postedDate:(new Date).getTime()},e.chatList=[],e.getChatList=function(s){e.loading=!0;var a={fromUser:o.fromUserId,toUser:o.toUserId};t({method:"POST",url:h.nodeJsUrl+"getChatList",headers:{"Content-Type":"application/json"},data:a}).then(function(s){e.loading=!1,1==s.data.success?(e.messageData.senderName=s.data.fromUser,e.messageData.recieverName=s.data.toUser,s.data.chats.length>0&&(e.chatList=s.data.chats,e.scrollTo("onLoad"))):(e.msgContent="You have'nt sent any message to this person yet.",e.toasterClass="warningClass",e.showAlertMessage()),document.getElementById("chatInput").focus()},function(s){e.loading=!1,e.createTable()})},e.getChatList(),e.sendMessage=function(s){var a=e.messageData,n=Math.random().toString(36).slice(2).substring(0,6);a.msgId=n,t({method:"POST",url:h.nodeJsUrl+"sendMessage",headers:{"Content-Type":"application/json"},data:a}).then(function(s){1==s.data.success&&(e.connectChatWs(a),e.messageData.message="")})},e.sendNotification=function(e,s){var a={app_id:h.app_id,contents:{en:s.message},included_segments:["Active Users","Inactive Users"],url:"https://jaffarchatapp.github.io/jaffarChatApp/#!/home/chat/25sl29juhjxbima/vsncvm18d71z1x6"};t({method:"POST",url:h.notifyUrl,headers:{Authorization:h.REST_API_KEY,"Content-Type":"application/json"},data:a}).then(function(e){})},e.connectChatWs=function(s){0==g&&(userMessages=new WebSocket(h.nodeJsChatUrl));var t={fromUserId:o.fromUserId,toUserId:o.toUserId,connectWS:g,chat:s},a=JSON.stringify(t);userMessages.onopen=function(){userMessages.send(a),c(function(){g=!0},200)},void 0!=t.chat&&userMessages.send(a),userMessages.onmessage=function(s){var t=s.data,a=JSON.parse(t);1==a.data.seccess&&"message"==a.type&&(e.chatList.push(a.data.message.chat),e.scrollTo())},userMessages.onerror=function(e){userMessages.onclose()},userMessages.onclose=function(){g=!1}},c(function(){e.connectChatWs()},800),e.scrollTo=function(s){var t=e.chatList.length-1,a="chat"+e.chatList[t].msgId;c(function(){var e=document.querySelector("#"+a);e&&e.scrollIntoView(e)},300),"onLoad"!=s&&e.$apply()},e.showAlertMessage=function(){i.show(i.simple().textContent(e.msgContent).position("top left").hideDelay(3e3).toastClass(e.toasterClass))},s.$on("$stateChangeStart",function(s,t,a,n,o){e.pageChanged=!0,userMessages.close()})}]);